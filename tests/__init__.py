import unittest
import pyorient
import json
import random


import scaner.tasks as task
import scaner.influence_metrics as metrics


class UnitTests(unittest.TestCase):

    client = pyorient.OrientDB("orientdb_test", 2424)
    session_id = client.connect("root", "root")
    client.db_open("mixedemotions", "admin", "admin")
    userlist = client.query("select id, followers_count, friends_count, statuses_count, topics from User where pending = false and topics containsText 'Caixabank' and depth < 2 limit -1")
    number_of_tweets = client.query("select count(*) as count from Tweet where topics containsText 'Caixabank'")
    number_of_tweets = number_of_tweets[0].oRecordData['count']
    number_of_users = len(userlist);

    def test_user_metrics(self):
        js = task.get_user_metrics(84333477)
        assert  all (k in js for k in ('influenceUnnormalized','influence','voice_r','tweetRatio','lastMetrics','relevance','statuses_count','complete','following','impact','id','voice','date','followers'))

    def test_user_in_DB(self):
    	js = task.user(2359753596)
    	assert 'id' in js

    def test_user_not_in_DB(self):
        js = task.user(random.randint(0, 20))
        assert js == "User not found in DB"

    def test_user_network(self):
        js = task.user_network(2359753596)
        network = [{'id': 748645976647270404}, {'id': 751365783452811264}, {'id': 751385737728237568}, {'id': 748754982564794368}, {'id': 751376008784252928}, {'id': 751394562422243328}]
        assert js == network

    def test_tweet_in_DB(self):
        js = task.tweet(748754982564794368)
        assert 'id' in js

    def test_tweet_not_in_DB(self):
        js = task.tweet(random.randint(0, 20))
        assert js == "Tweet not found in DB"

    def test_tweet_metrics(self):
        js = task.get_tweet_metrics(748754982564794368)
        assert  all (k in js for k in ('date','influence','lastMetrics','relevance','complete','id','topic','timestamp'))

    def test_tweet_history(self):
        js = task.tweet_history(748754982564794368)
        for i in js:
            if not all (k in i for k in ('date','influence','lastMetrics','relevance','complete','id','topic','timestamp')):
                assert False
        assert True

    def test_user_tweetratio_score(self):
        client = pyorient.OrientDB("orientdb_test", 2424)
        session_id = client.connect("root", "root")
        client.db_open("mixedemotions", "admin", "admin")
        userlist = client.query("select id, followers_count, friends_count, statuses_count, topics from User where pending = false and topics containsText 'Caixabank' and depth < 2 limit -1")
        js = metrics.user_tweetratio_score(userlist,'Caixabank')
        metrics_calculated = {738027896669884416: '0.000073112776', 706282957066080257: '0.000512295081', 512356611: '0.000032961962', 506555142: '0.000135336310', 3369510785: '0.008064516129', 369377032: '0.009900990099', 1350537228: '0.001727115716', 619504143: '0.003401360544', 883173379: '0.009803921568', 259752728: '0.000116009280', 168621018: '0.012987012987', 1363786782: '0.000775193798', 111356966: '0.000852514919', 303703335: '0.000229937916', 2788752424: '0.013333333333', 3330336297: '0.000577700751', 3320495914: '0.006329113924', 2587647020: '0.000881834215', 132685875: '0.000208920923', 383361585: '0.002403846153', 262098995: '0.003610108303', 173121078: '0.000236183278', 95947579: '0.000050622659', 3386910789: '0.000276931597', 21289030: '0.000167588402', 369346119: '0.001523229246', 2328682056: '0.006289308176', 4127985737: '0.000150466445', 3296782669: '0.000351988736', 298636367: '0.002217294900', 345876232: '0.000657894736', 3255593041: '0.008771929824', 349527634: '0.000259067357', 28329301: '0.006493506493', 2786083158: '0.002688172043', 1301627748: '0.005494505494', 2869234779: '0.000660066006', 246633564: '0.000031099362', 1106157150: '0.000271591526', 488562015: '0.009259259259', 402157156: '0.009345794392', 46862437: '0.000020067024', 169841500: '0.003448275862', 2789646701: '0.012500000000', 337936494: '0.004484304932', 2476229999: '0.004694835680', 4652099969: '0.007042253521', 167198834: '0.000016953175', 230871674: '0.002528445006', 628489085: '0.002164502164', 1244324737: '0.001153402537', 123844484: '0.000633713561', 178358917: '0.000093870271', 724665555274313728: '0.014285714285', 3505048455: '0.002659574468', 709131918: '0.000041165816', 1575783056: '0.000113417262', 714456721: '0.005952380952', 3873983123: '0.002849002849', 963389028: '0.000243783520', 197620373: '0.000035747480', 15145623: '0.005449591280', 167142554: '0.074074074074', 179100271: '0.000060020407', 3827081117: '0.000368731563', 3099313823: '0.000071983876', 3922322848: '0.000145475705', 3380553893: '0.004926108374', 219575463: '0.000160307790', 722848460680998912: '0.000028329414', 2893321900: '0.001834862385', 246333357: '0.000432900432', 4871665582: '0.000051012600', 802404271: '0.001876172607', 216072369: '0.000524383848', 2192142259: '0.000663129973', 2811761153: '0.000073131490', 3088719543: '0.001422475106', 738821048: '0.001253132832', 135081147: '0.000015080909', 281007039: '0.000159515074', 2852425120: '0.001160092807', 3306074567: '0.083333333333', 44719562: '0.003861003861', 239943120: '0.000850340136', 4796425937: '0.000627352572', 106970834: '0.000314564328', 4784728282: '0.000058068637', 33157347: '0.001930501930', 120036324: '0.000209599664', 752504209245896704: '0.062500000000', 344812266: '0.000016526194', 765416941: '0.001264222503', 338571759: '0.000075075075', 3309884913: '0.000117274539', 2784147198: '0.000417014178', 624590889: '0.000759878419', 581124858: '0.016666666666', 2188095486: '0.000457456541', 2869482495: '0.006012024048'}
        client.db_close()
        assert js == metrics_calculated
    
    def test_influence_score(self):   
        client = pyorient.OrientDB("orientdb_test", 2424)
        session_id = client.connect("root", "root")
        client.db_open("mixedemotions", "admin", "admin")
        userlist = client.query("select id, followers_count, friends_count, statuses_count, topics from User where pending = false and topics containsText 'Caixabank' and depth < 2 limit -1")
        number_of_tweets = client.query("select count(*) as count from Tweet where topics containsText 'Caixabank'")
        number_of_tweets = number_of_tweets[0].oRecordData['count']
        number_of_users = len(userlist);
        js = metrics.influence_score(userlist, number_of_users, number_of_tweets, 'Caixabank')
        client.db_close()
        assert True

    def test_follow_relation_factor_user(self):
        client = pyorient.OrientDB("orientdb_test", 2424)
        session_id = client.connect("root", "root")
        client.db_open("mixedemotions", "admin", "admin")
        userlist = client.query("select id, followers_count, friends_count, statuses_count, topics from User where pending = false and topics containsText 'Caixabank' and depth < 2 limit -1")
        number_of_users = len(userlist);
        js = metrics.follow_relation_factor_user(userlist, number_of_users, 'Caixabank')
        follow_relation_calculated = {738027896669884416: '0.333333333333', 706282957066080257: '0.333333333333', 512356611: '0.333333333333', 506555142: '0.500000000000', 3369510785: '0.504761904761', 369377032: '0.333333333333', 1350537228: '0.333333333333', 619504143: '0.333333333333', 883173379: '0.333333333333', 259752728: '0.333333333333', 168621018: '0.589743589743', 1363786782: '0.758974358974', 111356966: '0.333333333333', 303703335: '0.333333333333', 2788752424: '0.333333333333', 3330336297: '0.333333333333', 3320495914: '0.333333333333', 2587647020: '0.685714285714', 132685875: '0.400000000000', 383361585: '0.333333333333', 262098995: '0.999999999999', 173121078: '0.857142857142', 95947579: '0.333333333333', 3386910789: '0.464102564102', 21289030: '0.500000000000', 369346119: '0.523076923076', 2328682056: '1.000000000000', 4127985737: '0.333333333333', 3296782669: '0.333333333333', 298636367: '0.333333333333', 345876232: '0.571428571428', 3255593041: '0.333333333333', 349527634: '0.333333333333', 28329301: '0.333333333333', 2786083158: '0.333333333333', 1301627748: '0.333333333333', 2869234779: '0.333333333333', 246633564: '0.333333333333', 1106157150: '0.476190476190', 488562015: '0.333333333333', 402157156: '0.333333333333', 46862437: '0.333333333333', 169841500: '0.333333333333', 2789646701: '0.333333333333', 337936494: '0.476190476190', 2476229999: '0.333333333333', 4652099969: '0.333333333333', 167198834: '0.761904761904', 230871674: '0.476190476190', 628489085: '0.333333333333', 1244324737: '0.333333333333', 123844484: '0.476190476190', 178358917: '0.333333333333', 724665555274313728: '0.333333333333', 3505048455: '0.333333333333', 709131918: '0.333333333333', 1575783056: '0.400000000000', 714456721: '0.333333333333', 3873983123: '0.333333333333', 963389028: '0.333333333333', 197620373: '0.333333333333', 15145623: '0.333333333333', 167142554: '0.333333333333', 179100271: '0.666666666666', 3827081117: '0.333333333333', 3099313823: '0.571428571428', 3922322848: '0.333333333333', 3380553893: '0.333333333333', 219575463: '0.333333333333', 722848460680998912: '0.400000000000', 2893321900: '0.333333333333', 246333357: '0.333333333333', 4871665582: '0.333333333333', 802404271: '0.333333333333', 216072369: '0.333333333333', 2192142259: '0.333333333333', 2811761153: '0.333333333333', 3088719543: '0.333333333333', 738821048: '0.704761904761', 135081147: '0.333333333333', 281007039: '0.333333333333', 2852425120: '0.999999999999', 3306074567: '0.333333333333', 44719562: '0.333333333333', 239943120: '0.333333333333', 4796425937: '0.333333333333', 106970834: '0.333333333333', 4784728282: '0.333333333333', 33157347: '0.583333333333', 120036324: '0.533333333333', 752504209245896704: '0.333333333333', 344812266: '0.476190476190', 765416941: '0.333333333333', 338571759: '0.333333333333', 3309884913: '0.333333333333', 2784147198: '0.333333333333', 624590889: '1.000000000000', 581124858: '0.333333333333', 2188095486: '0.333333333333', 2869482495: '0.571428571428'}
        client.db_close()
        assert js == follow_relation_calculated

    def test_impact_user(self):
        client = pyorient.OrientDB("orientdb_test", 2424)
        session_id = client.connect("root", "root")
        client.db_open("mixedemotions", "admin", "admin")
        userlist = client.query("select id, followers_count, friends_count, statuses_count, topics from User where pending = false and topics containsText 'Caixabank' and depth < 2 limit -1")
        number_of_tweets = client.query("select count(*) as count from Tweet where topics containsText 'Caixabank'")
        number_of_tweets = number_of_tweets[0].oRecordData['count']
        js = metrics.impact_user(userlist, number_of_tweets, 'Caixabank')
        impact_user_calculated = {738027896669884416: '0.000000000000', 706282957066080257: '0.000000000000', 512356611: '0.000000000000', 506555142: '0.000000000000', 3369510785: '0.000000000000', 369377032: '0.000000000000', 1350537228: '0.000000000000', 619504143: '0.000000000000', 883173379: '0.000000000000', 259752728: '0.000000000000', 168621018: '0.000000000000', 1363786782: '0.000000000000', 111356966: '0.000000000000', 303703335: '0.000000000000', 2788752424: '0.000000000000', 3330336297: '0.000000000000', 3320495914: '0.000000000000', 2587647020: '0.000000000000', 132685875: '0.000000000000', 383361585: '0.000000000000', 262098995: '0.000000000000', 173121078: '0.000000000000', 95947579: '0.000000000000', 3386910789: '0.000000000000', 21289030: '0.000000000000', 369346119: '0.000000000000', 2328682056: '0.000000000000', 4127985737: '0.000000000000', 3296782669: '0.000000000000', 298636367: '0.000000000000', 345876232: '0.000000000000', 3255593041: '0.000000000000', 349527634: '0.000000000000', 28329301: '0.000000000000', 2786083158: '0.000000000000', 1301627748: '0.000000000000', 2869234779: '0.000000000000', 246633564: '0.000000000000', 1106157150: '0.000000000000', 488562015: '0.000000000000', 402157156: '0.000000000000', 46862437: '0.000000000000', 169841500: '0.000000000000', 2789646701: '0.000000000000', 337936494: '0.000000000000', 2476229999: '0.000000000000', 4652099969: '0.000000000000', 167198834: '0.000000000000', 230871674: '0.000000000000', 628489085: '0.000000000000', 1244324737: '0.000000000000', 123844484: '0.000000000000', 178358917: '0.000000000000', 724665555274313728: '0.000000000000', 3505048455: '0.000000000000', 709131918: '0.000000000000', 1575783056: '0.000000000000', 714456721: '0.000000000000', 3873983123: '0.000000000000', 963389028: '0.000000000000', 197620373: '0.000000000000', 15145623: '0.000000000000', 167142554: '0.000000000000', 179100271: '0.000000000000', 3827081117: '0.000000000000', 3099313823: '0.000000000000', 3922322848: '0.000000000000', 3380553893: '0.000000000000', 219575463: '0.000000000000', 722848460680998912: '0.000000000000', 2893321900: '0.000000000000', 246333357: '0.000000000000', 4871665582: '0.000000000000', 802404271: '0.000000000000', 216072369: '0.000000000000', 2192142259: '0.000000000000', 2811761153: '0.000000000000', 3088719543: '0.000000000000', 738821048: '0.000000000000', 135081147: '0.000000000000', 281007039: '0.000000000000', 2852425120: '0.000000000000', 3306074567: '0.000000000000', 44719562: '0.000000000000', 239943120: '0.000000000000', 4796425937: '0.000000000000', 106970834: '0.000000000000', 4784728282: '0.000000000000', 33157347: '0.000000000000', 120036324: '0.000000000000', 752504209245896704: '0.000000000000', 344812266: '0.000000000000', 765416941: '0.000000000000', 338571759: '0.000000000000', 3309884913: '0.000000000000', 2784147198: '0.000000000000', 624590889: '0.000000000000', 581124858: '0.000000000000', 2188095486: '0.000000000000', 2869482495: '0.000000000000'}
        client.db_close()
        assert js == impact_user_calculated

    def test_voice_user(self):
        client = pyorient.OrientDB("orientdb_test", 2424)
        session_id = client.connect("root", "root")
        client.db_open("mixedemotions", "admin", "admin")
        userlist = client.query("select id, followers_count, friends_count, statuses_count, topics from User where pending = false and topics containsText 'Caixabank' and depth < 2 limit -1")
        js = metrics.voice_user(userlist, 'Caixabank')
        voice_user_calculated = {738027896669884416: {'0.000000000000'}, 706282957066080257: {'0.000000000000'}, 512356611: {'0.000000000000'}, 506555142: {'0.000000000000'}, 3369510785: {'0.000000000000'}, 369377032: {'0.000000000000'}, 1350537228: {'0.000000000000'}, 619504143: {'0.000000000000'}, 883173379: {'0.000000000000'}, 259752728: {'0.000000000000'}, 168621018: {'0.000000000000', '0.000000592531'}, 1363786782: {'0.000001347959'}, 111356966: {'0.000000000000'}, 303703335: {'0.000000000000'}, 2788752424: {'0.000000000000'}, 3330336297: {'0.000000000000'}, 3320495914: {'0.000000000000'}, 2587647020: {'0.000000000000'}, 132685875: {'0.000000000000'}, 383361585: {'0.000000000000'}, 262098995: {'0.000000000000', '0.666666666666'}, 173121078: {'0.000000000000'}, 95947579: {'0.000000000000'}, 3386910789: {'0.000000673979'}, 21289030: {'0.000000000000'}, 369346119: {'0.000000000000', '0.000000711038'}, 2328682056: {'0.000000000000'}, 4127985737: {'0.000000000000'}, 3296782669: {'0.000000000000'}, 298636367: {'0.000000000000'}, 345876232: {'0.000000000000'}, 3255593041: {'0.000000000000'}, 349527634: {'0.000000000000'}, 28329301: {'0.000000000000'}, 2786083158: {'0.000000000000'}, 1301627748: {'0.000000000000'}, 2869234779: {'0.000000000000'}, 246633564: {'0.000000000000'}, 1106157150: {'0.000000000000'}, 488562015: {'0.000000000000'}, 402157156: {'0.000000000000'}, 46862437: {'0.000000000000'}, 169841500: {'0.000000000000'}, 2789646701: {'0.000000000000'}, 337936494: {'0.000007432223'}, 2476229999: {'0.000000000000'}, 4652099969: {'0.000000000000'}, 167198834: {'0.000000000000'}, 230871674: {'0.000008918667'}, 628489085: {'0.000000000000'}, 1244324737: {'0.000000000000'}, 123844484: {'0.000000000000'}, 178358917: {'0.000000000000'}, 724665555274313728: {'0.000000000000'}, 3505048455: {'0.000000000000'}, 709131918: {'0.000000000000'}, 1575783056: {'0.000000000000'}, 714456721: {'0.000000000000'}, 3873983123: {'0.000000000000'}, 963389028: {'0.000000000000'}, 197620373: {'0.000000000000'}, 15145623: {'0.000000000000'}, 167142554: {'0.000000000000'}, 179100271: {'0.000000000000'}, 3827081117: {'0.000000000000'}, 3099313823: {'0.000000000000'}, 3922322848: {'0.000000000000'}, 3380553893: {'0.000000000000'}, 219575463: {'0.000000000000'}, 722848460680998912: {'0.000000000000'}, 2893321900: {'0.000000000000'}, 246333357: {'0.000000000000'}, 4871665582: {'0.000000000000'}, 802404271: {'0.000000000000'}, 216072369: {'0.000000000000'}, 2192142259: {'0.000000000000'}, 2811761153: {'0.000000000000'}, 3088719543: {'0.000000000000'}, 738821048: {'0.000000000000'}, 135081147: {'0.000000000000'}, 281007039: {'0.000000000000'}, 2852425120: {'0.666666666666'}, 3306074567: {'0.000000000000'}, 44719562: {'0.000000000000'}, 239943120: {'0.000000000000'}, 4796425937: {'0.000000000000'}, 106970834: {'0.000000000000'}, 4784728282: {'0.000000000000'}, 33157347: {'0.000000000000'}, 120036324: {'0.000000000000'}, 752504209245896704: {'0.000000000000'}, 344812266: {'0.000000000000'}, 765416941: {'0.000000000000'}, 338571759: {'0.000000000000'}, 3309884913: {'0.000000000000'}, 2784147198: {'0.000000000000'}, 624590889: {'0.000000000000'}, 581124858: {'0.000000000000'}, 2188095486: {'0.000000000000'}, 2869482495: {'0.000007802208', '0.000007282061'}}
        client.db_close()
        assert js = voice_user_calculated